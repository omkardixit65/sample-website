<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Piano Chord Finder | Find Songs by Genre</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            poppins: ['Poppins', 'sans-serif'],
          },
          colors: {
            // Light Mode
            'light-bg': '#f7f8fa',
            'light-surface': '#ffffff',
            'light-text': '#1f2937',
            'light-subtle': '#6b7280',
            'light-highlight': '#e0e7ff', // Indigo-100 for light mode highlights
            // Dark Mode
            'dark-bg': '#111827',
            'dark-surface': '#1f2937',
            'dark-text': '#f3f4f6',
            'dark-subtle': '#9ca3af',
            'dark-highlight': '#3730a3', // Indigo-800 for dark mode highlights
            // Piano key colors
            'piano-white': '#ffffff',
            'piano-black': '#374151',
            'piano-white-dark': '#4b5563',
            'piano-black-dark': '#1f2937',
            'piano-highlight': '#4f46e5',
            'piano-highlight-dark': '#818cf8',
          }
        },
      },
    };
  </script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .modal-placeholder {
      font-style: italic;
      color: #9ca3af; /* Tailwind gray-400 */
    }
    .dark .modal-placeholder {
      color: #4b5563; /* Tailwind gray-600 */
    }
    #song-modal {
      transition: opacity 300ms ease-in-out;
    }
    #song-modal > div > div { /* The direct child, which is the modal content container */
      transition: transform 300ms ease-in-out;
    }
    .filter-btn-active {
      background-color: #4f46e5 !important; /* Indigo-600 */
      color: #ffffff !important;
      border-color: #4f46e5 !important;
    }
    .favorite-btn.favorited svg {
        fill: #ef4444; /* red-500 */
        color: #ef4444;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    .song-card:focus-visible { /* Using focus-visible for better accessibility */
        outline: 2px solid #4f46e5;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    .difficulty-dots {
        font-size: 1.2em;
        line-height: 1;
        letter-spacing: 0.1em; /* Add some spacing between dots */
    }
    .piano-key-display {
        display: inline-block;
        margin-left: 10px;
        vertical-align: middle;
        border: 1px solid #e5e7eb; /* Light border for the SVG container */
        border-radius: 4px;
        overflow: hidden; /* Clip keys if they somehow exceed bounds */
    }
    .dark .piano-key-display {
        border-color: #374151; /* Darker border for dark mode */
    }
    .chord-item-container {
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 40px;
    }
  </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-500">

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-3 tracking-tight"><a href="index.html">🎹 Piano Chord Finder</a></h1>
      <p class="text-lg text-light-subtle dark:text-dark-subtle max-w-2xl mx-auto">Find simple chords for hundreds of rock, pop, and classic songs.</p>
    </header>

    <main>
      <div class="mb-8 space-y-6">
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="relative flex-grow">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-light-subtle dark:text-dark-subtle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <input id="search-bar" type="text" placeholder="Search songs or artists..." class="w-full pl-11 pr-10 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-light-surface dark:bg-dark-surface text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow" aria-label="Search songs or artists">
            <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-3 flex items-center text-light-subtle dark:text-dark-subtle hover:text-light-text dark:hover:text-dark-text transition-colors hidden" aria-label="Clear search">
              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
          <button id="toggle-dark" class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-light-surface dark:bg-dark-surface hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center justify-center gap-2" aria-pressed="false" aria-label="Toggle dark mode">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <span class="sm:hidden">Toggle Mode</span>
          </button>
        </div>
        <div class="space-y-3">
          <label class="block text-sm font-medium text-light-subtle dark:text-dark-subtle text-center sm:text-left">Filter by Genre:</label>
          <div id="filter-container" class="flex flex-wrap items-center justify-center sm:justify-start gap-2 sm:gap-3" role="group" aria-label="Genre Filters">
            </div>
        </div>
        <div class="space-y-3">
            <label class="block text-sm font-medium text-light-subtle dark:text-dark-subtle text-center sm:text-left">Filter by Difficulty:</label>
            <div id="difficulty-filter-container" class="flex flex-wrap items-center justify-center sm:justify-start gap-2 sm:gap-3" role="group" aria-label="Difficulty Filters">
              </div>
        </div>
      </div>

      <div id="song-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" tabindex="0" aria-label="List of songs. Use arrow keys to navigate.">
        </div>
       <div id="no-results" class="hidden text-center py-16">
          <p class="text-xl font-medium text-light-subtle dark:text-dark-subtle">🤔 No songs found...</p>
          <p class="text-gray-500 dark:text-gray-400 mt-2">Try a different search or filter combination.</p>
       </div>
    </main>

    <section id="tips-section" class="mt-20 bg-light-surface dark:bg-dark-surface p-8 rounded-xl shadow-md max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold text-center mb-6">Tips for Better Playing</h2>
      <div class="space-y-4 text-light-subtle dark:text-dark-subtle text-base md:text-lg leading-relaxed">
        <p><strong>Start with the Root:</strong> Begin by playing the root note of the chord with your left hand and the full chord with your right hand. This builds a strong foundation.</p>
        <p><strong>Feel the Rhythm:</strong> Listen to the original song. Try to tap out the rhythm. This will help you understand when to change chords and how to strum or arpeggiate.</p>
        <p><strong>Master Smooth Transitions:</strong> Practice moving between the chords of a song slowly. As you get more comfortable, use chord inversions to minimize hand movement and make transitions seamless.</p>
        <p><strong>Consistency is Key:</strong> A little practice every day is more effective than one long session per week. Build that muscle memory!</p>
        <p><strong>Most Importantly, Have Fun!</strong> Music is an expression of joy. Don't be afraid to experiment and make these songs your own.</p>
      </div>
    </section>

  </div>

  <div id="song-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none" role="dialog" aria-modal="true" aria-labelledby="modal-song-title">
    <div class="bg-light-surface dark:bg-dark-surface w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 text-light-text dark:text-dark-text overflow-y-auto max-h-[90vh]">
      <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-light-text dark:hover:text-dark-text transition text-2xl z-10" aria-label="Close modal">✖</button>
      <div id="transpose-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

      <div class="flex justify-between items-start mb-1">
        <h2 id="modal-song-title" class="text-3xl font-bold"></h2>
        <button id="modal-favorite-btn" class="favorite-btn p-2 rounded-full hover:bg-light-highlight dark:hover:bg-dark-highlight transition-colors" aria-label="Add to favorites">
          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
        </button>
      </div>
      <p id="modal-song-artist" class="text-lg text-light-subtle dark:text-dark-subtle mb-1 italic"></p>
      <p id="modal-song-bpm" class="text-sm text-light-subtle dark:text-dark-subtle mb-4"></p>

      <div id="transpose-controls" class="my-4 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-light-bg dark:bg-dark-bg shadow-sm">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-md font-semibold text-light-text dark:text-dark-text">Transpose Chords:</h4>
          <p id="transpose-indicator" class="text-sm text-light-subtle dark:text-dark-subtle italic"></p> {/* Comment removed */}
        </div>
        <div class="flex items-center justify-center space-x-2 sm:space-x-3">
          <button id="transpose-down-btn" class="px-3 py-2 rounded-md bg-indigo-500 text-white font-semibold text-xs sm:text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-light-surface dark:focus:ring-offset-dark-surface focus:ring-indigo-400 flex items-center gap-1" aria-label="Transpose down one semitone">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
            <span class="hidden sm:inline">Down</span><span class="sm:hidden">-</span>
          </button>
          <button id="transpose-reset-btn" class="px-3 py-2 rounded-md bg-gray-400 hover:bg-gray-500 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-semibold text-xs sm:text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-light-surface dark:focus:ring-offset-dark-surface focus:ring-gray-300" aria-label="Reset transposition to original key">
            Reset
          </button>
          <button id="transpose-up-btn" class="px-3 py-2 rounded-md bg-indigo-500 text-white font-semibold text-xs sm:text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-light-surface dark:focus:ring-offset-dark-surface focus:ring-indigo-400 flex items-center gap-1" aria-label="Transpose up one semitone">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
            <span class="hidden sm:inline">Up</span><span class="sm:hidden">+</span>
          </button>
        </div>
      </div>
      <div id="modal-song-chords" class="space-y-3 text-base mt-6"></div>

      <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold mb-3 text-light-text dark:text-dark-text">Share this song:</h4>
        <div class="flex space-x-3">
          <button id="share-twitter" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">Twitter</button>
          <button id="share-facebook" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors text-sm">Facebook</button>
          <button id="share-email" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">Email</button>
        </div>
      </div>
    </div>
  </div>

<script>
    // --- CONFIGURATION ---
    const AppConfig = {
        genres: ['All', 'My Favorites', 'Recently Viewed', 'Pop', 'Classic Rock', 'Alternative & Indie', 'Grunge', 'R&B / Soul', 'Soundtrack', 'Hindi Songs'],
        difficulties: ["Beginner", "Intermediate", "Advanced"], // Order matters for difficulty dots
        genericChords: [ // Used for songs in popularAdditions without specified chords
            { "Verse": ["C", "G", "Am", "F"], "Chorus": ["F", "C", "G", "C"] },
            { "Verse": ["G", "D", "Em", "C"], "Chorus": ["G", "D", "C", "G"] },
            { "Verse": ["Am", "F", "C", "G"], "Chorus": ["F", "G", "C", "Am"] },
            { "Main": ["D", "A", "Bm", "G"] }
        ],
        maxRecentlyViewed: 15,
        notesSharp: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
        notesFlat:  ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'],
        chordTypes: {
            '': [0, 4, 7],         // Major (default)
            'm': [0, 3, 7],        // Minor
            'maj': [0, 4, 7],      // Major (explicit, e.g. Cmaj)
            '7': [0, 4, 7, 10],    // Dominant 7th
            'maj7': [0, 4, 7, 11], // Major 7th
            'm7': [0, 3, 7, 10],   // Minor 7th
            'dim': [0, 3, 6],      // Diminished
            'dim7': [0, 3, 6, 9],  // Diminished 7th
            'aug': [0, 4, 8],      // Augmented
            'sus4': [0, 5, 7],     // Suspended 4th
            'sus2': [0, 2, 7],     // Suspended 2nd
            '6': [0, 4, 7, 9],     // Major 6th (e.g., C6)
            'm6': [0, 3, 7, 9],    // Minor 6th (e.g., Cm6)
            'add9': [0, 4, 7, 14], // Added 9th (Root, 3rd, 5th, 9th) (14 semitones = octave + major 2nd)
            'm7b5': [0, 3, 6, 10], // Minor 7th flat 5 (Half-diminished)
            '7sus4': [0, 5, 7, 10],// 7th Suspended 4th
        },
        transposeLimit: 11, // NEW: Max semitones up or down
        initialSongData: [
            // POP SONGS
            { id: 23, title: "Imagine", artist: "John Lennon", genre: "Pop", difficulty: "Beginner", bpm: 76, chords: { "Verse": ["C", "Cmaj7", "F"], "Chorus": ["F", "G", "C", "E7"] } },
            { id: 25, title: "Someone Like You", artist: "Adele", genre: "Pop", difficulty: "Intermediate", bpm: 67, chords: { "Verse": ["A", "E", "F#m", "D"], "Chorus": ["A", "E", "F#m", "D"] } },
            { id: 31, title: "Perfect", artist: "Ed Sheeran", genre: "Pop", difficulty: "Beginner", bpm: 95, chords: { "Verse": ["G", "Em", "C", "D"], "Chorus": ["G", "Em", "C", "D"] } },
            { id: 55, title: "Shape of You", artist: "Ed Sheeran", genre: "Pop", difficulty: "Intermediate", chords: { "Verse": ["C#m", "F#m", "A", "B"], "Chorus": ["C#m", "F#m", "A", "B"] } },
            { id: 57, title: "Blinding Lights", artist: "The Weeknd", genre: "Pop", difficulty: "Intermediate", chords: { "Verse": ["Fm", "Cm", "Eb", "Bb"], "Chorus": ["Fm", "Cm", "Eb", "Bb"] } },
            { id: 59, title: "Watermelon Sugar", artist: "Harry Styles", genre: "Pop", difficulty: "Beginner", chords: { "Verse": ["Dm", "Am", "C", "G"], "Chorus": ["Dm", "Am", "C", "G"] } },
            { id: 60, title: "Bad Guy", artist: "Billie Eilish", genre: "Pop", difficulty: "Beginner", chords: { "Verse": ["Em", "D", "G"], "Chorus": ["Em", "G", "Am"] } },
            { id: 61, title: "Shake It Off", artist: "Taylor Swift", genre: "Pop", difficulty: "Beginner", chords: { "Verse": ["Am", "C", "G"], "Chorus": ["Am", "C", "G", "F"] } },
            { id: 62, title: "Happy", artist: "Pharrell Williams", genre: "Pop", difficulty: "Beginner", chords: { "Verse": ["Fm", "Db", "Ab", "Eb"], "Chorus": ["Fm", "Db", "Ab", "Eb"] } },
            { id: 64, title: "Royals", artist: "Lorde", genre: "Pop", difficulty: "Beginner", chords: { "Verse": ["D", "C", "G"], "Chorus": ["D", "C", "G"] } },
            // CLASSIC ROCK SONGS
            { id: 1, title: "Bohemian Rhapsody", artist: "Queen", genre: "Classic Rock", difficulty: "Advanced", bpm: 72, chords: { "Intro": ["Bb", "Gm", "Eb", "F", "Bb6"], "Ballad": ["Bb", "Gm", "Cm", "F", "Eb/G", "F/A"], "Opera": ["A", "D", "G", "C#dim", "F#7"] } },
            { id: 14, title: "Stairway to Heaven", artist: "Led Zeppelin", genre: "Classic Rock", difficulty: "Advanced", chords: { "Intro": ["Am", "G#aug", "C/G", "D/F#", "Fmaj7", "G/B", "Am"], "Verse": ["Am", "G", "C", "D", "Fmaj7"] } },
            { id: 16, title: "Sweet Child O' Mine", artist: "Guns N' Roses", genre: "Classic Rock", difficulty: "Intermediate", chords: { "Verse": ["D", "C", "G"], "Chorus": ["A", "C", "D", "G"] } },
            { id: 18, title: "Knockin' on Heaven's Door", artist: "Bob Dylan", genre: "Classic Rock", difficulty: "Beginner", chords: { "Verse": ["G", "D", "Am"], "Chorus": ["G", "D", "C"] } },
            { id: 20, title: "Hey Jude", artist: "The Beatles", genre: "Classic Rock", difficulty: "Beginner", chords: { "Verse": ["F", "C", "C7", "F", "Bb"], "Outro": ["F", "Eb", "Bb", "F"] } },
            { id: 22, title: "Let It Be", artist: "The Beatles", genre: "Classic Rock", difficulty: "Beginner", chords: { "Verse": ["C", "G", "Am", "F"], "Chorus": ["F", "C", "G", "C"] } },
            { id: 43, title: "Piano Man", artist: "Billy Joel", genre: "Classic Rock", difficulty: "Intermediate", chords: { "Verse": ["C", "G/B", "Am", "Am/G", "F", "C/E", "D7", "G"], "Chorus": ["F", "C/E", "D7", "G", "C"] } },
            { id: 44, title: "Hotel California", artist: "Eagles", genre: "Classic Rock", difficulty: "Intermediate", chords: { "Verse": ["Am", "E7", "G", "D", "F", "C", "Dm", "E"], "Chorus": ["F", "C", "E7", "Am"] } },
            { id: 66, title: "Sweet Home Alabama", artist: "Lynyrd Skynyrd", genre: "Classic Rock", difficulty: "Beginner", chords: { "Verse": ["D", "C", "G"], "Chorus": ["D", "C", "G"] } },
            { id: 67, title: "More Than a Feeling", artist: "Boston", genre: "Classic Rock", difficulty: "Intermediate", chords: { "Verse": ["G", "Cadd9", "Em7", "D"], "Chorus": ["G", "Cadd9", "Em7", "D"] } },
            // GRUNGE
            { id: 6, title: "Smells Like Teen Spirit", artist: "Nirvana", genre: "Grunge", difficulty: "Intermediate", chords: { "Verse": ["Fm", "Bb", "G#", "C#"] } },
            { id: 8, title: "Black Hole Sun", artist: "Soundgarden", genre: "Grunge", difficulty: "Advanced", chords: { "Verse": ["A", "G", "D", "E", "Cmaj7/G"], "Chorus": ["E", "A", "D", "G", "C"] } },
            { id: 11, title: "Plush", artist: "Stone Temple Pilots", genre: "Grunge", difficulty: "Intermediate", chords: { "Verse": ["G", "D/F#", "Em", "Cadd9"] } },
            { id: 12, title: "Alive", artist: "Pearl Jam", genre: "Grunge", difficulty: "Intermediate", chords: { "Verse": ["A", "G", "D", "E"] } },
            { id: 71, title: "Lithium", artist: "Nirvana", genre: "Grunge", difficulty: "Beginner", chords: { "Verse": ["E", "G#", "C#m", "A", "C", "D"] } },
            // ALTERNATIVE & INDIE
            { id: 17, title: "Everlong", artist: "Foo Fighters", genre: "Alternative & Indie", difficulty: "Intermediate", chords: { "Verse": ["Dmaj7", "Bm7", "G", "Asus4"] } },
            { id: 27, title: "Clocks", artist: "Coldplay", genre: "Alternative & Indie", difficulty: "Intermediate", chords: { "Verse": ["Eb", "Bbm7", "Fm7"] } },
            { id: 38, title: "Mr. Brightside", artist: "The Killers", genre: "Alternative & Indie", difficulty: "Intermediate", chords: { "Chorus": ["Db", "Ab", "Bbm", "Gb"] } },
            { id: 39, title: "Wonderwall", artist: "Oasis", genre: "Alternative & Indie", difficulty: "Beginner", chords: { "Verse": ["F#m", "A", "E", "B", "D", "C#m"] } },
            { id: 85, title: "Creep", artist: "Radiohead", genre: "Alternative & Indie", difficulty: "Beginner", chords: { "Verse": ["G", "B", "C", "Cm"] } },
            { id: 88, title: "Yellow", artist: "Coldplay", genre: "Alternative & Indie", difficulty: "Beginner", chords: { "Verse": ["G", "D", "Cadd9", "Em7"] } },
            { id: 93, title: "Zombie", artist: "The Cranberries", genre: "Alternative & Indie", difficulty: "Beginner", chords: { "Verse": ["Em", "C", "G", "D"] } },
            { id: 96, title: "Riptide", artist: "Vance Joy", genre: "Alternative & Indie", difficulty: "Beginner", chords: { "Verse": ["Am", "G", "C", "F"] } },
            // R&B / SOUL
            { id: 19, title: "Stand by Me", artist: "Ben E. King", genre: "R&B / Soul", difficulty: "Beginner", chords: { "Verse": ["G", "Em", "C", "D"] } },
            { id: 46, title: "Ain't No Sunshine", artist: "Bill Withers", genre: "R&B / Soul", difficulty: "Beginner", chords: { "Verse": ["Am7", "Em", "G", "Dm7"] } },
            { id: 47, title: "If I Ain't Got You", artist: "Alicia Keys", genre: "R&B / Soul", difficulty: "Intermediate", chords: { "Verse": ["Gmaj7", "Em7", "Am7", "D7", "Bm7"] } },
            { id: 100, title: "Respect", artist: "Aretha Franklin", genre: "R&B / Soul", difficulty: "Intermediate", chords: { "Verse": ["G", "F", "C", "Bb"] } },
            { id: 101, title: "Superstition", artist: "Stevie Wonder", genre: "R&B / Soul", difficulty: "Advanced", chords: { "Verse": ["Ebm7", "Ab7", "Dbmaj7", "Gbmaj7"] } },
            // SOUNDTRACK
            { id: 29, title: "What a Wonderful World", artist: "Louis Armstrong", genre: "Soundtrack", difficulty: "Beginner", chords: { "Verse": ["F", "Am", "Bb", "C7", "Gm7"] } },
            { id: 33, title: "Let It Go", artist: "Idina Menzel (from Frozen)", genre: "Soundtrack", difficulty: "Beginner", chords: { "Verse": ["Em", "C", "G", "D", "Am"] } },
            { id: 50, title: "My Heart Will Go On", artist: "Celine Dion (from Titanic)", genre: "Soundtrack", difficulty: "Intermediate", chords: { "Verse": ["E", "B", "A", "C#m", "F#m"] } },
            { id: 52, title: "Shallow", artist: "Lady Gaga & Bradley Cooper (A Star Is Born)", genre: "Soundtrack", difficulty: "Intermediate", chords: { "Verse": ["Em", "D/F#", "G", "C", "Am7"] } },
            { id: 112, title: "Over the Rainbow", artist: "Judy Garland (from The Wizard of Oz)", genre: "Soundtrack", difficulty: "Beginner", chords: { "Verse": ["C", "Em", "F", "G7", "Am"] } },
            { id: 121, title: "You've Got a Friend in Me", artist: "Randy Newman (from Toy Story)", genre: "Soundtrack", difficulty: "Beginner", chords: { "Verse": ["C", "G7", "E7", "Am", "D7", "F"] } },
            // HINDI SONGS
            { id: 125, title: "Kal Ho Naa Ho", artist: "Sonu Nigam", genre: "Hindi Songs", difficulty: "Intermediate", chords: { "Verse": ["C", "G", "Am", "F", "Dm"] } },
            { id: 126, title: "Tujhe Dekha Toh", artist: "Lata Mangeshkar, Kumar Sanu", genre: "Hindi Songs", difficulty: "Beginner", chords: { "Verse": ["G", "C", "D", "Em"] } },
            { id: 130, title: "Tum Hi Ho", artist: "Arijit Singh", genre: "Hindi Songs", difficulty: "Intermediate", chords: { "Verse": ["Em", "C", "G", "D", "Am"] } },
            { id: 132, title: "Gulabi Aankhen", artist: "Mohammed Rafi", genre: "Hindi Songs", difficulty: "Beginner", chords: { "Verse": ["Am", "G", "F", "E7"] } },
            { id: 138, title: "Pani Da Rang", artist: "Ayushmann Khurrana", genre: "Hindi Songs", difficulty: "Beginner", chords: { "Verse": ["C", "Am", "F", "G", "Em"] } }
        ],
        popularAdditions: {
            "Pop": [
                { title: "As It Was", artist: "Harry Styles" }, { title: "Levitating", artist: "Dua Lipa" },
                { title: "Stay", artist: "The Kid LAROI, Justin Bieber" }, { title: "good 4 u", artist: "Olivia Rodrigo" },
                { title: "Save Your Tears", artist: "The Weeknd" }, { title: "Peaches", artist: "Justin Bieber" },
                { title: "Drivers License", artist: "Olivia Rodrigo"}, { title: "Montero (Call Me By Your Name)", artist: "Lil Nas X"},
                { title: "Happier Than Ever", artist: "Billie Eilish"}, { title: "Anti-Hero", artist: "Taylor Swift"},
                { title: "Flowers", artist: "Miley Cyrus"}, { title: "Kill Bill", artist: "SZA"},
                { title: "Vampire", artist: "Olivia Rodrigo"}, { title: "Cruel Summer", artist: "Taylor Swift"},
                { title: "Dance The Night", artist: "Dua Lipa"}, { title: "greedy", artist: "Tate McRae"},
                { title: "Paint The Town Red", artist: "Doja Cat"}, { title: "Get Lucky", artist: "Daft Punk ft. Pharrell Williams"},
                { title: "Uptown Funk", artist: "Mark Ronson ft. Bruno Mars"},
                { title: "Sorry", artist: "Justin Bieber"}, { title: "Thinking Out Loud", artist: "Ed Sheeran"},
                { title: "Hello", artist: "Adele"}, { title: "Sugar", artist: "Maroon 5"},
                { title: "Can't Stop the Feeling!", artist: "Justin Timberlake"}, { title: "Closer", artist: "The Chainsmokers ft. Halsey"}
            ],
            "Classic Rock": [
                { title: "Livin' on a Prayer", artist: "Bon Jovi" }, { title: "Back in Black", artist: "AC/DC" },
                { title: "Another Brick in the Wall", artist: "Pink Floyd" }, { title: "Like a Rolling Stone", artist: "Bob Dylan" },
                { title: "Born to Run", artist: "Bruce Springsteen" }, { title: "Comfortably Numb", artist: "Pink Floyd" },
                { title: "Purple Haze", artist: "Jimi Hendrix" }, { title: "Whole Lotta Love", artist: "Led Zeppelin" },
                { title: "My Generation", artist: "The Who" }, { title: "(I Can't Get No) Satisfaction", artist: "The Rolling Stones" },
                { title: "Don't Stop Believin'", artist: "Journey"}, { title: "Highway to Hell", artist: "AC/DC"},
                { title: "Sweet Emotion", artist: "Aerosmith"}, { title: "Kashmir", artist: "Led Zeppelin"},
                { title: "Free Bird", artist: "Lynyrd Skynyrd"}, { title: "Smoke on the Water", artist: "Deep Purple"},
                { title: "Born to Be Wild", artist: "Steppenwolf"}, { title: "Light My Fire", artist: "The Doors"},
                { title: "Gimme Shelter", artist: "The Rolling Stones"}, { title: "Baba O'Riley", artist: "The Who"},
                { title: "Iron Man", artist: "Black Sabbath"}, { title: "Carry On Wayward Son", artist: "Kansas"}
            ],
            "Alternative & Indie": [
                { title: "Take Me to Church", artist: "Hozier" }, { title: "Do I Wanna Know?", artist: "Arctic Monkeys" },
                { title: "Little Talks", artist: "Of Monsters and Men" }, { title: "Somebody That I Used to Know", artist: "Gotye ft. Kimbra" },
                { title: "Sweater Weather", artist: "The Neighbourhood" },
                { title: "Skinny Love", artist: "Bon Iver"}, { title: "The Suburbs", artist: "Arcade Fire"},
                { title: "Lisztomania", artist: "Phoenix"}, { title: "Kids", artist: "MGMT"},
                { title: "Losing My Religion", artist: "R.E.M."}, { title: "The Less I Know The Better", artist: "Tame Impala"},
                { title: "Float On", artist: "Modest Mouse"}, { title: "Seven Nation Army", artist: "The White Stripes"},
                { title: "Pumped Up Kicks", artist: "Foster The People"},
                { title: "Ho Hey", artist: "The Lumineers"},
                { title: "Feel Good Inc.", artist: "Gorillaz"}, { title: "Island in the Sun", artist: "Weezer"},
                { title: "Last Nite", artist: "The Strokes"}, { title: "Stubborn Love", artist: "The Lumineers"}
            ],
            "Grunge": [
                { title: "Heart-Shaped Box", artist: "Nirvana" }, { title: "Glycerine", artist: "Bush" },
                { title: "Black", artist: "Pearl Jam" }, { title: "Outshined", artist: "Soundgarden" },
                { title: "Them Bones", artist: "Alice in Chains" }, {title: "Vasoline", artist: "Stone Temple Pilots"},
                {title: "Polly", artist: "Nirvana"}, {title: "Rusty Cage", artist: "Soundgarden"},
                {title: "No Excuses", artist: "Alice in Chains"}, {title: "Far Behind", artist: "Candlebox"},
                {title: "Jeremy", artist: "Pearl Jam"}, {title: "Would?", artist: "Alice in Chains"},
                {title: "Hunger Strike", artist: "Temple of the Dog"}, {title: "Man in the Box", artist: "Alice in Chains"},
                {title: "Even Flow", artist: "Pearl Jam"}, {title: "Come As You Are", artist: "Nirvana"}
            ],
            "R&B / Soul": [
                { title: "Sexual Healing", artist: "Marvin Gaye" },
                { title: "If You Don't Know Me by Now", artist: "Harold Melvin & The Blue Notes" },
                { title: "Crazy in Love", artist: "Beyoncé ft. Jay-Z" }, { title: "Signed, Sealed, Delivered I'm Yours", artist: "Stevie Wonder"},
                { title: "At Last", artist: "Etta James"}, { title: "A Change Is Gonna Come", artist: "Sam Cooke"},
                { title: "I Got You (I Feel Good)", artist: "James Brown"},
                { title: "No Scrubs", artist: "TLC"}, { title: "Doo Wop (That Thing)", artist: "Lauryn Hill"},
                { title: "Leave The Door Open", artist: "Silk Sonic"}, { title: "Waterfalls", artist: "TLC"},
                { title: "My Girl", artist: "The Temptations"}, { title: "Let's Get It On", artist: "Marvin Gaye"},
                { title: "Sittin' On The Dock of the Bay", artist: "Otis Redding"},
                { title: "I Heard It Through the Grapevine", artist: "Marvin Gaye"}
            ],
            "Soundtrack": [
                { title: "Can't Stop the Feeling!", artist: "Justin Timberlake (Trolls)" }, { title: "Skyfall", artist: "Adele (James Bond)" },
                { title: "Danger Zone", artist: "Kenny Loggins (Top Gun)" }, { title: "Lose Yourself", artist: "Eminem (8 Mile)" },
                { title: "The Power of Love", artist: "Huey Lewis & The News (Back to the Future)"}, { title: "Footloose", artist: "Kenny Loggins (Footloose)"},
                { title: "Gonna Fly Now", artist: "Bill Conti (Rocky)"}, { title: "Hakuna Matata", artist: "Various Artists (The Lion King)"},
                { title: "Stayin' Alive", artist: "Bee Gees (Saturday Night Fever)"}, { title: "Time of My Life", artist: "Bill Medley, Jennifer Warnes (Dirty Dancing)"},
                { title: "Part of Your World", artist: "Jodi Benson (The Little Mermaid)"}, { title: "Circle of Life", artist: "Elton John (The Lion King)"},
                { title: "Theme from Jurassic Park", artist: "John Williams"}, { title: "Star Wars Main Theme", artist: "John Williams"},
                { title: "Defying Gravity", artist: "Idina Menzel, Kristin Chenoweth (Wicked)"}
            ],
            "Hindi Songs": [
                { title: "Kesariya", artist: "Arijit Singh (Brahmastra)" }, { title: "Channa Mereya", artist: "Arijit Singh (Ae Dil Hai Mushkil)" },
                { title: "Tum Sath Ho", artist: "Arijit Singh, Alka Yagnik (Tamasha)" }, { title: "Lag Jaa Gale", artist: "Lata Mangeshkar (Woh Kaun Thi?)" },
                { title: "Chura Liya Hai Tumne Jo Dil Ko", artist: "Asha Bhosle, Mohammed Rafi (Yaadon Ki Baaraat)" },
                { title: "Tere Bina Zindagi Se", artist: "Lata Mangeshkar, Kishore Kumar (Aandhi)"},
                { title: "Yeh Dosti Hum Nahin Todenge", artist: "Kishore Kumar, Manna Dey (Sholay)"},
                { title: "Papa Kehte Hain", artist: "Udit Narayan (Qayamat Se Qayamat Tak)"},
                { title: "Tujh Mein Rab Dikhta Hai", artist: "Roop Kumar Rathod (Rab Ne Bana Di Jodi)"},
                { title: "Dil Chahta Hai", artist: "Shankar Mahadevan (Dil Chahta Hai)"},
                { title: "Maa Tujhe Salaam", artist: "A.R. Rahman"}, { title: "Jai Ho", artist: "A.R. Rahman, Sukhwinder Singh (Slumdog Millionaire)"},
                { title: "Tera Zikr", artist: "Darshan Raval"}, { title: "Ghungroo", artist: "Arijit Singh, Shilpa Rao (War)"},
                { title: "Apna Time Aayega", artist: "Ranveer Singh (Gully Boy)"}, { title: "Bekhayali", artist: "Sachet Tandon (Kabir Singh)"}
            ]
        }
    };

    // --- DOM ELEMENTS ---
    const DOM = {
        songGrid: document.getElementById('song-grid'),
        modal: document.getElementById('song-modal'),
        closeModalBtn: document.getElementById('close-modal'),
        modalTitle: document.getElementById('modal-song-title'),
        modalArtist: document.getElementById('modal-song-artist'),
        modalBpm: document.getElementById('modal-song-bpm'),
        modalChords: document.getElementById('modal-song-chords'),
        modalFavoriteBtn: document.getElementById('modal-favorite-btn'),
        toggleDarkBtn: document.getElementById('toggle-dark'),
        searchBar: document.getElementById('search-bar'),
        clearSearchBtn: document.getElementById('clear-search-btn'),
        filterContainer: document.getElementById('filter-container'),
        difficultyFilterContainer: document.getElementById('difficulty-filter-container'),
        noResultsDiv: document.getElementById('no-results'),
        shareTwitterBtn: document.getElementById('share-twitter'),
        shareFacebookBtn: document.getElementById('share-facebook'),
        shareEmailBtn: document.getElementById('share-email'),
        transposeAnnouncer: document.getElementById('transpose-announcer'),
        transposeIndicator: document.getElementById('transpose-indicator'),
        transposeDownBtn: document.getElementById('transpose-down-btn'),
        transposeResetBtn: document.getElementById('transpose-reset-btn'),
        transposeUpBtn: document.getElementById('transpose-up-btn')
    };

    // --- APPLICATION STATE ---
    let AppState = {
        currentGenreFilter: 'All',
        currentDifficultyFilter: 'All',
        favorites: [],
        recentlyViewed: [],
        currentModalSongId: null,
        currentTransposeOffset: 0,
        songData: [],
        activeElementBeforeModal: null,
        focusedCardIndex: -1
    };

    // --- MUSIC THEORY HELPERS ---
    const MusicTheory = {
        getNoteIndex: function(noteName) {
            let i = AppConfig.notesSharp.indexOf(noteName);
            if (i !== -1) return i;
            i = AppConfig.notesFlat.indexOf(noteName);
            if (i !== -1) return AppConfig.notesFlat.indexOf(noteName);
            return -1;
        },
        getNoteFromIndex: function(index, preferFlat = false) {
            const normalizedIndex = ((index % 12) + 12) % 12;
            const sharpNote = AppConfig.notesSharp[normalizedIndex];
            if (preferFlat) {
                const flatEquivalent = AppConfig.notesFlat[normalizedIndex];
                if (flatEquivalent && flatEquivalent.includes('b')) {
                    return flatEquivalent;
                }
            }
            return sharpNote;
        },
        parseChordName: function(chordName) {
            const pattern = /^([A-Ga-g][#b]?)((?:maj7|m7b5|7sus4|add9|sus4|sus2|m7|m6|dim7|dim|aug|maj|m|6|7)?)(\/(?:[A-Ga-g][#b]?))?(.*)$/;
            const match = chordName.match(pattern);
            if (!match) {
                console.warn("Could not parse chord:", chordName);
                return { root: chordName, type: '', bass: null, rest: '' };
            }
            let root = match[1];
            let type = match[2] || '';
            let bass = match[3] ? match[3].substring(1) : null;
            let rest = match[4] || '';
            if (type === 'maj' && !chordName.toLowerCase().includes('maj7')) type = '';
            return { root, type, bass, rest };
        },
        getNotesForChord: function(chordName) {
            const parsed = this.parseChordName(chordName);
            if (!parsed || parsed.root === chordName && parsed.type === '' && parsed.bass === null) {
                 console.warn(`Cannot get notes for unparsed or basic root-only string: ${chordName}`);
                 if (AppConfig.notesSharp.includes(parsed.root) || AppConfig.notesFlat.includes(parsed.root)) {
                    const rootIdx = this.getNoteIndex(parsed.root);
                    if (rootIdx !== -1) {
                        return AppConfig.chordTypes[''].map(interval => this.getNoteFromIndex((rootIdx + interval)));
                    }
                 }
                 return [];
            }
            const rootIndex = this.getNoteIndex(parsed.root);
            if (rootIndex === -1) {
                console.warn(`Root note '${parsed.root}' not found for chord: ${chordName}`);
                return [];
            }
            const intervals = AppConfig.chordTypes[parsed.type];
            if (!intervals) {
                console.warn(`Unknown chord type '${parsed.type}' for chord: ${chordName}. Cannot determine notes.`);
                return [parsed.root];
            }
            let notesInChord = intervals.map(interval => this.getNoteFromIndex((rootIndex + interval)));
            if (parsed.bass) {
                const bassNoteName = parsed.bass;
                const bassNoteIndex = this.getNoteIndex(bassNoteName);
                if (bassNoteIndex !== -1) {
                    const isBassNoteInChordVoicing = notesInChord.some(note => this.getNoteIndex(note) === bassNoteIndex);
                    if (!isBassNoteInChordVoicing) {
                         notesInChord.push(bassNoteName);
                    }
                } else {
                    console.warn(`Bass note '${parsed.bass}' not found for slash chord: ${chordName}`);
                }
            }
            return [...new Set(notesInChord)];
        }
    };

    // --- CHORD TRANSPOSITION ---
    const ChordTransposer = {
        transposeNote: function(note, semitones) {
            const noteIndex = MusicTheory.getNoteIndex(note);
            if (noteIndex === -1) return note;
            let transposedIndex = (noteIndex + semitones);
            transposedIndex = ((transposedIndex % 12) + 12) % 12;
            const originalIsFlat = AppConfig.notesFlat.includes(note) && note.includes('b');
            return MusicTheory.getNoteFromIndex(transposedIndex, originalIsFlat);
        },
        transposeFullChord: function(fullChord, semitones) {
            if (semitones === 0) return fullChord;
            const parsed = MusicTheory.parseChordName(fullChord);
            if (!parsed || (parsed.root === fullChord && parsed.type === '' && parsed.bass === null)) {
                if (MusicTheory.getNoteIndex(fullChord) !== -1) {
                    return this.transposeNote(fullChord, semitones);
                }
                return fullChord;
            }
            let transposedRoot = this.transposeNote(parsed.root, semitones);
            let transposedBass = parsed.bass ? "/" + this.transposeNote(parsed.bass, semitones) : "";
            return transposedRoot + parsed.type + transposedBass + parsed.rest;
        }
    };

    // --- PIANO KEY SVG DISPLAY ---
    const PianoKeyDisplay = {
        createSVG: function(notesToHighlight, isDarkMode) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const keyWidth = 10;
            const keyHeight = 45;
            const blackKeyWidth = keyWidth * 0.65;
            const blackKeyHeight = keyHeight * 0.6;
            const displayOctaveNotes = AppConfig.notesSharp;
            const whiteKeyPositionsInOctave = [0, 2, 4, 5, 7, 9, 11];
            const blackKeyPositionsInOctave = [1, 3, 6, 8, 10];
            const highlightColor = isDarkMode ? tailwind.config.theme.extend.colors['piano-highlight-dark'] : tailwind.config.theme.extend.colors['piano-highlight'];
            const whiteKeyFill = isDarkMode ? tailwind.config.theme.extend.colors['piano-white-dark'] : tailwind.config.theme.extend.colors['piano-white'];
            const blackKeyFill = isDarkMode ? tailwind.config.theme.extend.colors['piano-black-dark'] : tailwind.config.theme.extend.colors['piano-black'];
            const keyStrokeColor = isDarkMode ? "#4b5563" : "#d1d5db";
            svg.setAttribute("width", keyWidth * 7);
            svg.setAttribute("height", keyHeight);
            svg.setAttribute("viewBox", `0 0 ${keyWidth * 7} ${keyHeight}`);
            svg.classList.add("piano-key-display");
            for (let i = 0; i < 7; i++) {
                const rect = document.createElementNS(svgNS, "rect");
                rect.setAttribute("x", i * keyWidth);
                rect.setAttribute("y", 0);
                rect.setAttribute("width", keyWidth);
                rect.setAttribute("height", keyHeight);
                rect.setAttribute("stroke", keyStrokeColor);
                rect.setAttribute("stroke-width", "1");
                const whiteNoteName = displayOctaveNotes[whiteKeyPositionsInOctave[i]];
                rect.setAttribute("fill", notesToHighlight.includes(whiteNoteName) ? highlightColor : whiteKeyFill);
                svg.appendChild(rect);
            }
            const blackKeyXOffsetsFactors = [0.65, 1.70, 3.65, 4.70, 5.70];
            for (let i = 0; i < 5; i++) {
                const rect = document.createElementNS(svgNS, "rect");
                rect.setAttribute("x", blackKeyXOffsetsFactors[i] * keyWidth);
                rect.setAttribute("y", 0);
                rect.setAttribute("width", blackKeyWidth);
                rect.setAttribute("height", blackKeyHeight);
                rect.setAttribute("stroke", blackKeyFill);
                rect.setAttribute("stroke-width", "1");
                const blackNoteName = displayOctaveNotes[blackKeyPositionsInOctave[i]];
                rect.setAttribute("fill", notesToHighlight.includes(blackNoteName) ? highlightColor : blackKeyFill);
                svg.appendChild(rect);
            }
            return svg;
        }
    };

    // --- DATA MANAGEMENT ---
    const DataManager = {
        augmentSongData: function(initialSongs, popularAdditionsByGenre, genericChordsList, difficultyLevels) {
            const augmentedSongs = [...initialSongs];
            let maxId = initialSongs.reduce((max, song) => Math.max(max, song.id || 0), 0);
            for (const genreName in popularAdditionsByGenre) {
                if (popularAdditionsByGenre.hasOwnProperty(genreName)) {
                    const popularSongsInGenre = popularAdditionsByGenre[genreName];
                    popularSongsInGenre.forEach(popularSong => {
                        const songExists = augmentedSongs.some(s =>
                            s.title.toLowerCase() === popularSong.title.toLowerCase() &&
                            s.artist.toLowerCase() === popularSong.artist.toLowerCase() &&
                            s.genre === genreName
                        );
                        if (!songExists) {
                            maxId++;
                            augmentedSongs.push({
                                id: maxId,
                                title: popularSong.title,
                                artist: popularSong.artist,
                                genre: genreName,
                                chords: popularSong.chords || genericChordsList[maxId % genericChordsList.length],
                                difficulty: popularSong.difficulty || difficultyLevels[maxId % difficultyLevels.length],
                                bpm: popularSong.bpm
                            });
                        }
                    });
                }
            }
            return augmentedSongs;
        },
        initializeSongData: function() {
            AppState.songData = this.augmentSongData(
                AppConfig.initialSongData,
                AppConfig.popularAdditions,
                AppConfig.genericChords,
                AppConfig.difficulties
            );
        },
        getSongById: function(songId) {
            return AppState.songData.find(s => s.id === songId);
        }
    };

    // --- LOCAL STORAGE MANAGERS ---
    const FavoritesManager = {
        load: function() {
            const storedFavorites = localStorage.getItem('pianoChordFavorites_v2');
            if (storedFavorites) {
                try { AppState.favorites = JSON.parse(storedFavorites); }
                catch (e) { console.error("Error parsing favorites: ", e); AppState.favorites = []; }
            }
        },
        save: function() { localStorage.setItem('pianoChordFavorites_v2', JSON.stringify(AppState.favorites)); },
        isFavorite: function(songId) { return AppState.favorites.includes(songId); },
        toggle: function(songId, buttonElement) {
            const songIndex = AppState.favorites.indexOf(songId);
            if (songIndex > -1) AppState.favorites.splice(songIndex, 1);
            else AppState.favorites.push(songId);
            this.save();
            if (buttonElement) this.updateButtonState(buttonElement, songId);
            if (AppState.currentModalSongId === songId) {
                const otherButton = (buttonElement === DOM.modalFavoriteBtn)
                    ? DOM.songGrid.querySelector(`.favorite-btn-card[data-song-id="${songId}"]`)
                    : DOM.modalFavoriteBtn;
                if (otherButton) this.updateButtonState(otherButton, songId);
            }
            if (AppState.currentGenreFilter === 'My Favorites') SongRenderer.populate();
        },
        updateButtonState: function(buttonElement, songId) {
            if (!buttonElement) return;
            const heartIcon = buttonElement.querySelector('svg');
            const isFav = this.isFavorite(songId);
            buttonElement.classList.toggle('favorited', isFav);
            buttonElement.setAttribute('aria-label', isFav ? 'Remove from Favorites' : 'Add to Favorites');
            buttonElement.title = isFav ? 'Remove from Favorites' : 'Add to Favorites';
            if (heartIcon) heartIcon.setAttribute('fill', isFav ? '#ef4444' : 'none');
        }
    };

    const RecentlyViewedManager = {
        load: function() {
            const stored = localStorage.getItem('pianoChordRecentlyViewed_v2');
            if (stored) {
                try { AppState.recentlyViewed = JSON.parse(stored); }
                catch (e) { console.error("Error parsing recently viewed: ", e); AppState.recentlyViewed = []; }
            }
        },
        save: function() { localStorage.setItem('pianoChordRecentlyViewed_v2', JSON.stringify(AppState.recentlyViewed)); },
        add: function(songId) {
            AppState.recentlyViewed = AppState.recentlyViewed.filter(id => id !== songId);
            AppState.recentlyViewed.unshift(songId);
            if (AppState.recentlyViewed.length > AppConfig.maxRecentlyViewed) {
                AppState.recentlyViewed = AppState.recentlyViewed.slice(0, AppConfig.maxRecentlyViewed);
            }
            this.save();
        }
    };

    // --- FILTERING LOGIC ---
    const FilterManager = {
        createButtons: function(container, items, currentFilterStateProperty) {
            container.innerHTML = '';
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.textContent = item;
                btn.className = `filter-btn px-3 py-2 sm:px-4 rounded-md border text-xs sm:text-sm font-semibold transition-colors duration-200 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700 text-light-text dark:text-dark-text`;
                if (item === AppState[currentFilterStateProperty]) {
                    btn.classList.add('filter-btn-active');
                    btn.setAttribute('aria-pressed', 'true');
                } else {
                    btn.setAttribute('aria-pressed', 'false');
                }
                btn.setAttribute('role', 'button');
                btn.addEventListener('click', () => {
                    AppState[currentFilterStateProperty] = item;
                    container.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('filter-btn-active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('filter-btn-active');
                    btn.setAttribute('aria-pressed', 'true');
                    SongRenderer.populate();
                });
                container.appendChild(btn);
            });
        },
        init: function() {
            this.createButtons(DOM.filterContainer, AppConfig.genres, 'currentGenreFilter');
            this.createButtons(DOM.difficultyFilterContainer, ['All', ...AppConfig.difficulties], 'currentDifficultyFilter');
        }
    };

    // --- SONG CARD AND LIST RENDERING ---
    const SongRenderer = {
        getDifficultyVisuals: function(difficulty) {
            const difficultyIndex = AppConfig.difficulties.indexOf(difficulty);
            let visualHtml = '';
            if (difficultyIndex !== -1) {
                const totalDifficultyLevels = AppConfig.difficulties.length;
                let dots = '';
                const badgeColorClasses = this.getDifficultyBadgeColor(difficulty);
                const filledColorLight = badgeColorClasses.split(' ').find(c => c.startsWith('text-') && !c.includes('dark:text-')) || 'text-indigo-600';
                const filledColorDark = badgeColorClasses.split(' ').find(c => c.startsWith('dark:text-')) || 'dark:text-indigo-400';
                const emptyColor = 'text-gray-300 dark:text-gray-500';
                for (let i = 0; i < totalDifficultyLevels; i++) {
                    if (i <= difficultyIndex) {
                        dots += `<span class="${filledColorLight} ${filledColorDark.replace('dark:','') }">●</span>`;
                    } else {
                        dots += `<span class="${emptyColor}">○</span>`;
                    }
                }
                visualHtml = `<span class="difficulty-dots" aria-label="${difficulty}">${dots}</span><span class="sr-only"> ${difficulty}</span>`;
            } else {
                visualHtml = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${this.getDifficultyBadgeColor(difficulty)}">${difficulty || 'N/A'}</span>`;
            }
            return visualHtml;
        },
        getDifficultyBadgeColor: function(difficulty) {
            switch (difficulty?.toLowerCase()) {
                case 'beginner': return 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
                case 'intermediate': return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300';
                case 'advanced': return 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300';
                default: return 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
            }
        },
        createCardHTML: function(song) {
            const isFav = FavoritesManager.isFavorite(song.id);
            const difficultyVisual = this.getDifficultyVisuals(song.difficulty);
            const favoriteButtonHTML = `
                <button class="favorite-btn favorite-btn-card absolute top-2 right-2 p-1.5 rounded-full hover:bg-light-highlight dark:hover:bg-dark-highlight transition-colors z-10" data-song-id="${song.id}" title="${isFav ? 'Remove from Favorites' : 'Add to Favorites'}" aria-label="${isFav ? 'Remove from Favorites' : 'Add to Favorites'}">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500 pointer-events-none" fill="${isFav ? '#ef4444' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </button>
            `;
            return `
              <div class="song-card bg-light-surface dark:bg-dark-surface rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-5 flex flex-col transition-all duration-300 ease-in-out hover:shadow-xl hover:border-indigo-500 dark:hover:border-indigo-600 relative group h-40 cursor-pointer" data-song-id="${song.id}" tabindex="-1" role="button" aria-label="View ${song.title} by ${song.artist}">
                <div class="absolute top-3 left-3 flex items-center gap-2 pointer-events-none"> ${difficultyVisual} </div>
                ${favoriteButtonHTML}
                <div class="song-view-button w-full text-left focus:outline-none mt-auto flex-grow flex flex-col justify-end items-start pointer-events-none">
                  <h3 class="text-lg font-bold tracking-tight text-light-text dark:text-dark-text group-hover:text-indigo-600 dark:group-hover:text-indigo-400 pointer-events-none">${song.title}</h3>
                  <p class="text-light-subtle dark:text-dark-subtle text-sm pointer-events-none">${song.artist}</p>
                </div>
              </div>
            `;
        },
        populate: function() {
            const searchTerm = DOM.searchBar.value.toLowerCase().trim();
            DOM.songGrid.innerHTML = '';
            AppState.focusedCardIndex = -1;
            let songsToDisplay = [...AppState.songData];
            let sortByRecency = false;
            if (AppState.currentGenreFilter === 'My Favorites') {
                songsToDisplay = songsToDisplay.filter(song => FavoritesManager.isFavorite(song.id));
            } else if (AppState.currentGenreFilter === 'Recently Viewed') {
                const recentSongMap = new Map(AppState.songData.map(song => [song.id, song]));
                songsToDisplay = AppState.recentlyViewed
                                    .map(id => recentSongMap.get(id))
                                    .filter(song => song !== undefined);
                sortByRecency = true;
            } else if (AppState.currentGenreFilter !== 'All') {
                songsToDisplay = songsToDisplay.filter(song => song.genre === AppState.currentGenreFilter);
            }
            if (AppState.currentDifficultyFilter !== 'All') {
                songsToDisplay = songsToDisplay.filter(song => song.difficulty === AppState.currentDifficultyFilter);
            }
            if (searchTerm) {
                songsToDisplay = songsToDisplay.filter(song =>
                    song.title.toLowerCase().includes(searchTerm) ||
                    song.artist.toLowerCase().includes(searchTerm)
                );
            }
            DOM.noResultsDiv.classList.toggle('hidden', songsToDisplay.length > 0);
            if (!sortByRecency) {
                songsToDisplay.sort((a, b) => a.title.localeCompare(b.title));
            }
            const fragment = document.createDocumentFragment();
            songsToDisplay.forEach(song => {
                const cardWrapper = document.createElement('div');
                cardWrapper.innerHTML = this.createCardHTML(song).trim();
                fragment.appendChild(cardWrapper.firstChild);
            });
            DOM.songGrid.appendChild(fragment);
        }
    };

    // --- MODAL MANAGEMENT ---
    const ModalManager = {
        renderChords: function(songId, transposeOffset) {
            const song = DataManager.getSongById(songId);
            if (!song) {
                DOM.modalChords.innerHTML = `<p class="modal-placeholder">Song data not found.</p>`;
                return;
            }
            const isDarkMode = document.documentElement.classList.contains('dark');
            DOM.modalChords.innerHTML = '';
            const sections = song.chords ? Object.keys(song.chords) : [];
            if (sections.length === 0) {
                DOM.modalChords.innerHTML = `<p class="modal-placeholder">No chords available for this song yet.</p>`;
                return;
            }
            sections.forEach(section => {
                const originalChordsInSection = song.chords[section];
                if (!originalChordsInSection || originalChordsInSection.length === 0) return;
                const sectionBlock = document.createElement('div');
                sectionBlock.className = 'mb-4';
                const sectionTitleEl = document.createElement('h4');
                sectionTitleEl.className = 'text-xl font-semibold mb-2 border-b border-gray-200 dark:border-gray-600 pb-1 capitalize text-light-text dark:text-dark-text';
                sectionTitleEl.textContent = section;
                sectionBlock.appendChild(sectionTitleEl);
                const chordWrap = document.createElement('div');
                chordWrap.className = 'flex flex-wrap gap-x-4 gap-y-3';
                originalChordsInSection.forEach(originalChord => {
                    const transposedChordString = ChordTransposer.transposeFullChord(originalChord, transposeOffset);
                    const chordItemContainer = document.createElement('div');
                    chordItemContainer.className = 'chord-item-container';
                    const chordTextSpan = document.createElement('span');
                    chordTextSpan.className = `inline-flex items-center gap-2 px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-100 rounded-md font-medium text-sm shadow-sm`;
                    chordTextSpan.innerHTML = `<svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"></path></svg> ${transposedChordString}`;
                    chordItemContainer.appendChild(chordTextSpan);
                    const notesForSVG = MusicTheory.getNotesForChord(transposedChordString);
                    if (notesForSVG.length > 0) {
                       try {
                            const pianoSVG = PianoKeyDisplay.createSVG(notesForSVG, isDarkMode);
                            chordItemContainer.appendChild(pianoSVG);
                       } catch (e) {
                           console.error("Error creating piano SVG for chord:", transposedChordString, e);
                       }
                    }
                    chordWrap.appendChild(chordItemContainer);
                });
                sectionBlock.appendChild(chordWrap);
                DOM.modalChords.appendChild(sectionBlock);
            });
        },
        updateTransposeButtonStates: function() { // NEW function to manage button disabled states and styles
            const offset = AppState.currentTransposeOffset;
            const limit = AppConfig.transposeLimit;

            // Up Button
            if (offset >= limit) {
                DOM.transposeUpBtn.disabled = true;
                DOM.transposeUpBtn.classList.add('opacity-50', 'cursor-not-allowed');
                DOM.transposeUpBtn.classList.remove('hover:bg-indigo-600', 'dark:hover:bg-indigo-700'); // Use actual configured dark hover color
            } else {
                DOM.transposeUpBtn.disabled = false;
                DOM.transposeUpBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                DOM.transposeUpBtn.classList.add('hover:bg-indigo-600', 'dark:hover:bg-indigo-700');
            }

            // Down Button
            if (offset <= -limit) {
                DOM.transposeDownBtn.disabled = true;
                DOM.transposeDownBtn.classList.add('opacity-50', 'cursor-not-allowed');
                DOM.transposeDownBtn.classList.remove('hover:bg-indigo-600', 'dark:hover:bg-indigo-700');
            } else {
                DOM.transposeDownBtn.disabled = false;
                DOM.transposeDownBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                DOM.transposeDownBtn.classList.add('hover:bg-indigo-600', 'dark:hover:bg-indigo-700');
            }
             // Ensure hover classes match the initial setup from HTML if you have more specific ones there.
            // For dark mode, the original HTML has dark:bg-indigo-700 dark:hover:bg-indigo-800.
            // Let's ensure consistency:
            if (!DOM.transposeUpBtn.disabled) {
                DOM.transposeUpBtn.classList.add('dark:bg-indigo-700', 'dark:hover:bg-indigo-800');
            } else {
                 DOM.transposeUpBtn.classList.remove('dark:hover:bg-indigo-800');
            }
            if (!DOM.transposeDownBtn.disabled) {
                DOM.transposeDownBtn.classList.add('dark:bg-indigo-700', 'dark:hover:bg-indigo-800');
            } else {
                 DOM.transposeDownBtn.classList.remove('dark:hover:bg-indigo-800');
            }
        },
        updateTransposeIndicator: function() {
            if (AppState.currentTransposeOffset === 0) {
                DOM.transposeIndicator.textContent = "Original Key";
                DOM.transposeIndicator.className = 'text-sm text-light-subtle dark:text-dark-subtle italic';
            } else {
                const sign = AppState.currentTransposeOffset > 0 ? "+" : "";
                DOM.transposeIndicator.textContent = `${sign}${AppState.currentTransposeOffset} semitone${Math.abs(AppState.currentTransposeOffset) === 1 ? '' : 's'}`;
                DOM.transposeIndicator.className = 'text-sm font-semibold text-indigo-700 dark:text-indigo-300';
            }
            this.updateTransposeButtonStates(); // Call to update button states
        },
        open: function(songId) {
            const song = DataManager.getSongById(songId);
            if (!song) return;
            AppState.activeElementBeforeModal = document.activeElement;
            AppState.currentModalSongId = song.id;
            AppState.currentTransposeOffset = 0; // Reset transpose on new song
            RecentlyViewedManager.add(song.id);
            DOM.modal.querySelector('div > div').scrollTop = 0;
            DOM.modalTitle.textContent = song.title;
            DOM.modalArtist.textContent = `By ${song.artist}`;
            DOM.transposeAnnouncer.textContent = "";
            this.updateTransposeIndicator(); // This will also set initial button states
            if (song.bpm) {
                DOM.modalBpm.textContent = `Tempo: ${song.bpm} BPM`;
                DOM.modalBpm.classList.remove('hidden');
            } else {
                DOM.modalBpm.textContent = '';
                DOM.modalBpm.classList.add('hidden');
            }
            DOM.modalFavoriteBtn.dataset.songId = song.id;
            FavoritesManager.updateButtonState(DOM.modalFavoriteBtn, song.id);
            this.renderChords(song.id, AppState.currentTransposeOffset);
            const shareUrl = window.location.href.split('?')[0] + `?songId=${song.id}`;
            const shareText = `Check out the chords for ${song.title} by ${song.artist} on Piano Chord Finder!`;
            DOM.shareTwitterBtn.onclick = () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
            DOM.shareFacebookBtn.onclick = () => window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`, '_blank');
            DOM.shareEmailBtn.onclick = () => window.location.href = `mailto:?subject=${encodeURIComponent(song.title + ' - Piano Chords')}&body=${encodeURIComponent(shareText + '\n' + shareUrl)}`;
            DOM.modal.classList.remove('opacity-0', 'pointer-events-none');
            DOM.modal.querySelector('div > div').classList.remove('scale-95');
            document.body.style.overflow = 'hidden';
            DOM.closeModalBtn.focus();
        },
        close: function() {
            DOM.modal.classList.add('opacity-0', 'pointer-events-none');
            DOM.modal.querySelector('div > div').classList.add('scale-95');
            AppState.currentModalSongId = null;
            AppState.currentTransposeOffset = 0;
            DOM.transposeAnnouncer.textContent = "";
            DOM.transposeIndicator.textContent = "";
            document.body.style.overflow = '';
            if (AppState.activeElementBeforeModal) {
                AppState.activeElementBeforeModal.focus();
                AppState.activeElementBeforeModal = null;
            }
        },
        handleTranspose: function(semitones) {
            if (AppState.currentModalSongId === null) return;

            const newOffset = AppState.currentTransposeOffset + semitones;

            // Enforce transpose limits
            if (newOffset > AppConfig.transposeLimit || newOffset < -AppConfig.transposeLimit) {
                this.updateTransposeButtonStates(); // Ensure buttons reflect the unchangable state
                return; // Do not transpose further
            }

            AppState.currentTransposeOffset = newOffset;
            this.renderChords(AppState.currentModalSongId, AppState.currentTransposeOffset);
            this.updateTransposeIndicator(); // This will update text and button states

            let offsetText = AppState.currentTransposeOffset === 0 ? "Original Key" :
                             (AppState.currentTransposeOffset > 0 ? `+${AppState.currentTransposeOffset}` : AppState.currentTransposeOffset.toString()) +
                             ` semitone${Math.abs(AppState.currentTransposeOffset) === 1 ? '' : 's'}`;
            DOM.transposeAnnouncer.textContent = `Chords transposed. Current offset: ${offsetText}.`;
        },
        resetTranspose: function() {
            if (AppState.currentModalSongId === null) return;
            AppState.currentTransposeOffset = 0;
            this.renderChords(AppState.currentModalSongId, AppState.currentTransposeOffset);
            this.updateTransposeIndicator(); // This will update text and button states
            DOM.transposeAnnouncer.textContent = "Chords reset to original key.";
        }
    };

    // --- THEME MANAGEMENT ---
    const ThemeManager = {
        init: function() {
            const isDarkMode = localStorage.getItem('darkMode_v2') === 'true';
            if (isDarkMode) document.documentElement.classList.add('dark');
            DOM.toggleDarkBtn.setAttribute('aria-pressed', isDarkMode.toString());
        },
        toggle: function() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode_v2', isDark);
            DOM.toggleDarkBtn.setAttribute('aria-pressed', isDark.toString());
            if (AppState.currentModalSongId !== null && !DOM.modal.classList.contains('pointer-events-none')) {
                ModalManager.renderChords(AppState.currentModalSongId, AppState.currentTransposeOffset);
                 // Re-apply button states if theme change affects their appearance (though Tailwind should handle this)
                ModalManager.updateTransposeButtonStates();
            }
        }
    };

    // --- EVENT LISTENERS ---
    const EventListeners = {
        initModalKeys: function() {
            document.addEventListener('keydown', (e) => {
                if (DOM.modal.classList.contains('pointer-events-none')) return;
                if (e.key === '=' || e.key === '+') {
                    e.preventDefault();
                    ModalManager.handleTranspose(1); // Limit handled within function
                } else if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    ModalManager.handleTranspose(-1); // Limit handled within function
                } else if (e.key === '0' || e.key === 'r' || e.key === 'R') {
                    if(document.activeElement !== DOM.searchBar) {
                        e.preventDefault();
                        ModalManager.resetTranspose();
                    }
                }
            });
        },
        initGridNavigationKeys: function() {
            DOM.songGrid.addEventListener('keydown', (e) => {
                const cards = Array.from(DOM.songGrid.querySelectorAll('.song-card'));
                if (cards.length === 0) return;
                let newIndex = AppState.focusedCardIndex;
                const gridStyles = window.getComputedStyle(DOM.songGrid);
                const columnCount = gridStyles.getPropertyValue('grid-template-columns').split(' ').length;
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (AppState.focusedCardIndex + 1 < cards.length) newIndex = AppState.focusedCardIndex + 1;
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                     if (AppState.focusedCardIndex - 1 >= 0) newIndex = AppState.focusedCardIndex - 1;
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    newIndex = AppState.focusedCardIndex + columnCount;
                    if (newIndex >= cards.length) newIndex = cards.length -1;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    newIndex = AppState.focusedCardIndex - columnCount;
                     if (newIndex < 0) newIndex = 0;
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (AppState.focusedCardIndex >= 0 && cards[AppState.focusedCardIndex]) {
                        const songId = parseInt(cards[AppState.focusedCardIndex].dataset.songId);
                        ModalManager.open(songId);
                    }
                    return;
                } else if (e.key === 'Home') {
                    e.preventDefault(); newIndex = 0;
                } else if (e.key === 'End') {
                    e.preventDefault(); newIndex = cards.length - 1;
                } else { return; }
                newIndex = Math.max(0, Math.min(cards.length - 1, newIndex));
                if (newIndex !== AppState.focusedCardIndex || (AppState.focusedCardIndex === -1 && newIndex === 0) ) {
                    AppState.focusedCardIndex = newIndex;
                    if (cards[AppState.focusedCardIndex]) cards[AppState.focusedCardIndex].focus();
                }
            });
            DOM.songGrid.addEventListener('focus', () => {
                if (AppState.focusedCardIndex === -1) {
                    const cards = Array.from(DOM.songGrid.querySelectorAll('.song-card'));
                    if (cards.length > 0) {
                        AppState.focusedCardIndex = 0;
                        cards[0].focus();
                    }
                }
            }, { once: true });
        },
        init: function() {
            DOM.closeModalBtn.addEventListener('click', ModalManager.close);
            DOM.modal.addEventListener('click', (e) => { if (e.target === DOM.modal) ModalManager.close(); });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !DOM.modal.classList.contains('pointer-events-none')) ModalManager.close();
            });
            DOM.toggleDarkBtn.addEventListener('click', ThemeManager.toggle);
            DOM.searchBar.addEventListener('input', () => {
                SongRenderer.populate();
                DOM.clearSearchBtn.classList.toggle('hidden', DOM.searchBar.value === '');
            });
            DOM.clearSearchBtn.addEventListener('click', () => {
                DOM.searchBar.value = '';
                DOM.clearSearchBtn.classList.add('hidden');
                SongRenderer.populate();
                DOM.searchBar.focus();
            });
            DOM.modalFavoriteBtn.addEventListener('click', () => {
                if (AppState.currentModalSongId !== null) {
                    FavoritesManager.toggle(AppState.currentModalSongId, DOM.modalFavoriteBtn);
                }
            });
            DOM.songGrid.addEventListener('click', (event) => {
                const songCard = event.target.closest('.song-card');
                if (!songCard) return;
                const songId = parseInt(songCard.dataset.songId);
                if (isNaN(songId)) return;
                const favoriteButton = event.target.closest('.favorite-btn-card');
                if (favoriteButton) {
                    FavoritesManager.toggle(songId, favoriteButton);
                } else {
                    ModalManager.open(songId);
                    const cards = Array.from(DOM.songGrid.querySelectorAll('.song-card'));
                    AppState.focusedCardIndex = cards.indexOf(songCard);
                }
            });
            DOM.transposeDownBtn.addEventListener('click', () => ModalManager.handleTranspose(-1));
            DOM.transposeUpBtn.addEventListener('click', () => ModalManager.handleTranspose(1));
            DOM.transposeResetBtn.addEventListener('click', () => ModalManager.resetTranspose());
            this.initModalKeys();
            this.initGridNavigationKeys();
        }
    };

    // --- APPLICATION INITIALIZER ---
    const AppInitializer = {
        init: function() {
            ThemeManager.init();
            DataManager.initializeSongData();
            FavoritesManager.load();
            RecentlyViewedManager.load();
            FilterManager.init();
            SongRenderer.populate();
            EventListeners.init();
            const urlParams = new URLSearchParams(window.location.search);
            const songIdToOpen = urlParams.get('songId');
            if (songIdToOpen) {
                const songToOpen = DataManager.getSongById(parseInt(songIdToOpen));
                if (songToOpen) ModalManager.open(songToOpen.id);
                else window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    };

    document.addEventListener('DOMContentLoaded', AppInitializer.init);
</script>
</body>
</html>
